<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nmap_utils</title>
    <link rel="icon" type="image/svg+xml" href="https://n.maps.yandex.ru/favicon-dot.svg">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <style>
        @font-face {
            font-family: "YS Text";
            font-style: normal;
            font-weight: 400;
            src: local("YS Text Regular"), local("YS-Text-Regular"),
                 url("https://yastatic.net/s3/home/fonts/ys/1/text-regular.woff2") format("woff2");
        }
        @font-face {
            font-family: "YS Text";
            font-style: normal;
            font-weight: 500;
            src: local("YS Text Medium"), local("YS-Text-Medium"),
                 url("https://yastatic.net/s3/home/fonts/ys/1/text-medium.woff2") format("woff2");
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="https://n.maps.yandex.ru/#!" class="logo-link">
            <svg height="72" width="284" xmlns="http://www.w3.org/2000/svg" class="logo-svg"><g fill="#999"><path d="m71 36h3.1796c1.1293 0 2.0041.236 2.6243.7081.6294.4629.9441 1.1895.9441 2.1799 0 .5647-.0925 1.0507-.2777 1.4579-.1758.3981-.4258.7267-.7498.9859-.3239.2592-.7127.4489-1.1663.5692-.4443.1204-.9395.1805-1.4857.1805h-1.7633v3.8739h-1.3052zm1.3052 1.1941v3.7072h1.7633c.3518 0 .6711-.037.9581-.111.287-.0741.5322-.1898.7359-.3472.2129-.1573.3749-.361.486-.6109.1203-.2592.1805-.5693.1805-.9303 0-.6016-.1944-1.0367-.5832-1.3051-.3888-.2685-.9442-.4027-1.6662-.4027z"></path><path d="m84.7712 45.3445c-.1018.074-.2267.1527-.3748.236s-.3287.1666-.5416.25c-.2129.074-.4535.1342-.722.1805-.2684.0555-.5692.0833-.9025.0833-1.2126 0-2.1336-.3286-2.7631-.9859-.6294-.6572-.9441-1.5782-.9441-2.763 0-.5832.0833-1.1062.2499-1.569.1759-.4628.4165-.8516.722-1.1663.3055-.324.6665-.5693 1.083-.7359.4166-.1759.8701-.2639 1.3607-.2639.5184 0 .9812.088 1.3885.2639.4073.1758.7405.435.9997.7775.2685.3425.449.7683.5415 1.2774.1019.4999.1019 1.083 0 1.7495h-5.0818c.0463.7775.2777 1.3607.6942 1.7495.4166.3795 1.0368.5693 1.8606.5693.5554 0 1.0321-.0787 1.4301-.2361.3981-.1573.7313-.3286.9997-.5137zm-2.8602-5.6511c-.5276 0-.9812.162-1.3607.4859-.3796.324-.6202.8146-.722 1.4718h3.8738c.037-.6665-.1157-1.157-.4582-1.4718-.3425-.3239-.7868-.4859-1.3329-.4859z"></path><path d="m86.1193 44.9141c.2592-.1574.4628-.4027.6109-.7359.1481-.3333.2638-.7545.3471-1.2636s.1389-1.1107.1666-1.805c.0371-.6942.0695-1.481.0972-2.3604h4.9569v6.1649h1.083v3.0963h-1.0691l-.1527-2.055h-5.3596l-.1249 2.055h-1.0969v-3.0963zm4.9568 0v-5.1235h-2.6381c-.0462 1.3607-.1342 2.4529-.2638 3.2768-.1203.8145-.3332 1.4301-.6387 1.8467z"></path><path d="m98.8104 44.5808c-.0833.1666-.1897.3425-.3193.5276-.1296.1759-.2916.3379-.486.486s-.4258.2684-.6942.361c-.2592.0926-.5647.1389-.9164.1389-.648 0-1.171-.1805-1.569-.5415-.398-.3703-.5971-.8979-.5971-1.5829 0-.7868.2731-1.3654.8192-1.7356.5554-.3703 1.3422-.5554 2.3605-.5554h1.3468v-.5971c0-.4998-.1296-.8562-.3888-1.0691s-.7035-.3193-1.3329-.3193c-.4443 0-.8655.074-1.2635.2221-.3981.1389-.7545.3009-1.0692.486v-1.0969c.2592-.1574.6063-.3101 1.0414-.4582.4443-.1574.9303-.2361 1.4579-.2361.9071 0 1.5967.1898 2.0688.5693.4721.3703.7082.9488.7082 1.7356v3.8739.2916c.0092.1018.0138.2082.0138.3193.0093.1111.0184.2176.0274.3194.01.0925.019.1712.028.236h-1.1106c-.0278-.1296-.0555-.3101-.0833-.5415-.0185-.2407-.0278-.4489-.0278-.6248zm-2.1521.4166c.3795 0 .7035-.0787.9719-.2361.2685-.1573.486-.3378.6526-.5415.1666-.2129.287-.4165.361-.6109.0741-.2037.1111-.3471.1111-.4304v-.5277h-1.2219c-.7312 0-1.2635.1065-1.5967.3194-.324.2036-.486.5137-.486.9303 0 .3239.0972.5878.2916.7914s.4998.3055.9164.3055z"></path><path d="m103.759 42.8869h-.639v3.0685h-1.222v-7.2062h1.222v3.0963h.694l2.527-3.0963h1.389l-2.958 3.5545 3.013 3.6517h-1.486z"></path><path d="m111.973 39.7906v6.1648h-1.222v-6.1648h-2.263v-1.0414h5.79v1.0414z"></path><path d="m118.442 46.0943c-.491 0-.949-.0833-1.375-.25-.425-.1666-.796-.4073-1.11-.722-.306-.324-.547-.7174-.722-1.1802-.176-.4628-.264-.9951-.264-1.5967 0-.5925.088-1.1201.264-1.5829.175-.4721.416-.8655.722-1.1802.314-.3147.685-.5554 1.11-.722.426-.1666.884-.25 1.375-.25.5 0 .963.0834 1.388.25.426.1666.792.4073 1.097.722.315.3147.56.7081.736 1.1802.185.4628.278.9904.278 1.5829 0 .6016-.093 1.1339-.278 1.5967-.176.4628-.421.8562-.736 1.1802-.305.3147-.671.5554-1.097.722-.425.1667-.888.25-1.388.25zm0-1.0969c.324 0 .62-.0509.889-.1528.277-.111.518-.273.722-.4859.203-.2222.361-.4999.472-.8331.111-.3333.166-.7267.166-1.1802 0-.4536-.055-.847-.166-1.1802-.111-.3333-.269-.6064-.472-.8193-.204-.2221-.445-.3841-.722-.4859-.269-.1111-.565-.1666-.889-.1666s-.62.0555-.889.1666c-.268.1018-.504.2638-.708.4859-.194.2129-.347.486-.458.8193-.111.3332-.167.7266-.167 1.1802 0 .4535.056.8469.167 1.1802.111.3332.264.6109.458.8331.204.2129.44.3749.708.4859.269.1019.565.1528.889.1528z"></path><path d="m127.054 46.0943c-.555 0-1.037-.1296-1.444-.3888-.398-.2592-.717-.6156-.958-1.0691v3.7766h-1.222v-9.6638h1.069l.125 1.4024c.241-.4721.565-.847.972-1.1247.408-.2777.912-.4166 1.514-.4166.416 0 .814.0787 1.194.2361.389.1481.726.3795 1.013.6942.297.3055.528.6943.695 1.1664.176.4628.263 1.0089.263 1.6384 0 .6387-.087 1.1941-.263 1.6661-.176.4629-.412.8516-.708 1.1664-.297.3054-.639.5368-1.028.6942-.389.1481-.796.2222-1.222.2222zm-.18-1.0969c.638 0 1.152-.2176 1.541-.6526.398-.4443.597-1.1108.597-1.9994 0-.8702-.199-1.5274-.597-1.9717-.389-.4536-.903-.6803-1.541-.6803-.315 0-.611.0555-.889.1666-.268.1111-.504.2777-.708.4998-.194.2129-.352.486-.472.8192-.111.3333-.167.722-.167 1.1664 0 .4443.056.8331.167 1.1663.12.3332.278.6109.472.8331.204.2221.44.3888.708.4998.278.1019.574.1528.889.1528z"></path><path d="m134.904 38.9714c0-.5277.088-.9766.264-1.3469.175-.3795.421-.6896.736-.9303.323-.2406.708-.4165 1.152-.5276s.935-.1666 1.472-.1666h3.096v9.9554h-1.319v-3.9849h-1.805l-2.749 3.9849h-1.597l3.013-4.221c-.731-.1573-1.291-.4582-1.68-.9025-.389-.4536-.583-1.0737-.583-1.8605zm5.401 1.8189v-3.5962h-1.777c-.333 0-.639.0324-.917.0972-.268.0555-.504.1527-.708.2916-.194.1388-.347.3239-.458.5554-.111.2221-.167.4998-.167.8331 0 .6294.181 1.0922.542 1.3884.361.287.884.4305 1.569.4305z"></path><path d="m148.49 42.7619h-3.485v3.1935h-1.222v-7.2062h1.222v2.9713h3.485v-2.9713h1.222v7.2062h-1.222z"></path><path d="m151.326 44.9141c.26-.1574.463-.4027.611-.7359.148-.3333.264-.7545.347-1.2636.084-.5091.139-1.1107.167-1.805.037-.6942.069-1.481.097-2.3604h4.957v6.1649h1.083v3.0963h-1.069l-.153-2.055h-5.359l-.125 2.055h-1.097v-3.0963zm4.957 0v-5.1235h-2.638c-.046 1.3607-.134 2.4529-.264 3.2768-.12.8145-.333 1.4301-.638 1.8467z"></path><path d="m165.463 45.3445c-.102.074-.227.1527-.375.236s-.328.1666-.541.25c-.213.074-.454.1342-.722.1805-.269.0555-.569.0833-.903.0833-1.212 0-2.133-.3286-2.763-.9859-.629-.6572-.944-1.5782-.944-2.763 0-.5832.083-1.1062.25-1.569.176-.4628.417-.8516.722-1.1663.305-.324.666-.5693 1.083-.7359.417-.1759.87-.2639 1.361-.2639.518 0 .981.088 1.388.2639.407.1758.741.435 1 .7775.268.3425.449.7683.541 1.2774.102.4999.102 1.083 0 1.7495h-5.081c.046.7775.277 1.3607.694 1.7495.416.3795 1.037.5693 1.86.5693.556 0 1.032-.0787 1.43-.2361.399-.1573.732-.3286 1-.5137zm-2.86-5.6511c-.528 0-.981.162-1.361.4859-.379.324-.62.8146-.722 1.4718h3.874c.037-.6665-.116-1.157-.458-1.4718-.343-.3239-.787-.4859-1.333-.4859z"></path><path d="m169.061 42.8869h-.639v3.0685h-1.222v-7.2062h1.222v3.0963h.694l2.527-3.0963h1.389l-2.958 3.5545 3.013 3.6517h-1.486z"></path><path d="m177.212 46.0943c-.555 0-1.06-.0833-1.514-.25-.444-.1758-.823-.4211-1.138-.7359-.315-.3239-.555-.7173-.722-1.1802-.167-.4628-.25-.9904-.25-1.5828 0-.5832.083-1.1062.25-1.569.176-.4628.421-.8516.736-1.1663.315-.324.699-.5693 1.152-.7359.454-.1759.968-.2639 1.541-.2639.445 0 .852.051 1.222.1528.371.0925.676.2314.917.4165v1.0969c-.296-.1944-.63-.3378-1-.4304-.361-.1018-.736-.1527-1.125-.1527-.842 0-1.462.2175-1.86.6525-.389.4351-.583 1.1016-.583 1.9995 0 .8978.189 1.5643.569 1.9994.379.435.981.6526 1.805.6526.435 0 .833-.0509 1.194-.1528.37-.111.704-.2499 1-.4165v1.0969c-.259.1573-.574.2916-.944.4026-.361.1111-.778.1667-1.25.1667z"></path><path d="m181.561 46.0387c-.268 0-.486-.0833-.652-.2499-.167-.1759-.25-.3841-.25-.6248 0-.2592.083-.4721.25-.6387.166-.1666.384-.2499.652-.2499.26 0 .473.0833.639.2499.167.1666.25.3795.25.6387 0 .2407-.083.4489-.25.6248-.166.1666-.379.2499-.639.2499z"></path><path d="m186.744 41.6928h-1.055v4.2626h-1.305v-9.9554h1.305v4.5126h.972l3.554-4.5126h1.472l-3.929 4.9708 4.082 4.9846h-1.625z"></path><path d="m197.13 44.5808c-.084.1666-.19.3425-.32.5276-.129.1759-.291.3379-.486.486-.194.1481-.426.2684-.694.361-.259.0926-.565.1389-.916.1389-.648 0-1.171-.1805-1.569-.5415-.398-.3703-.597-.8979-.597-1.5829 0-.7868.273-1.3654.819-1.7356.555-.3703 1.342-.5554 2.36-.5554h1.347v-.5971c0-.4998-.13-.8562-.389-1.0691s-.703-.3193-1.333-.3193c-.444 0-.865.074-1.263.2221-.398.1389-.755.3009-1.069.486v-1.0969c.259-.1574.606-.3101 1.041-.4582.444-.1574.93-.2361 1.458-.2361.907 0 1.597.1898 2.069.5693.472.3703.708.9488.708 1.7356v3.8739.2916c.009.1018.014.2082.014.3193.009.1111.018.2176.028.3194.009.0925.018.1712.027.236h-1.11c-.028-.1296-.056-.3101-.084-.5415-.018-.2407-.028-.4489-.028-.6248zm-2.153.4166c.38 0 .704-.0787.972-.2361.269-.1573.486-.3378.653-.5415.167-.2129.287-.4165.361-.6109.074-.2037.111-.3471.111-.4304v-.5277h-1.222c-.731 0-1.263.1065-1.597.3194-.324.2036-.486.5137-.486.9303 0 .3239.098.5878.292.7914s.5.3055.916.3055z"></path><path d="m203.841 46.0943c-.555 0-1.037-.1296-1.444-.3888-.398-.2592-.717-.6156-.958-1.0691v3.7766h-1.222v-9.6638h1.069l.125 1.4024c.241-.4721.565-.847.972-1.1247s.912-.4166 1.514-.4166c.416 0 .814.0787 1.194.2361.388.1481.726.3795 1.013.6942.296.3055.528.6943.695 1.1664.175.4628.263 1.0089.263 1.6384 0 .6387-.088 1.1941-.263 1.6661-.176.4629-.412.8516-.709 1.1664-.296.3054-.638.5368-1.027.6942-.389.1481-.796.2222-1.222.2222zm-.18-1.0969c.638 0 1.152-.2176 1.541-.6526.398-.4443.597-1.1108.597-1.9994 0-.8702-.199-1.5274-.597-1.9717-.389-.4536-.903-.6803-1.541-.6803-.315 0-.611.0555-.889.1666-.269.1111-.505.2777-.708.4998-.195.2129-.352.486-.472.8192-.111.3333-.167.722-.167 1.1664 0 .4443.056.8331.167 1.1663.12.3332.277.6109.472.8331.203.2221.439.3888.708.4998.278.1019.574.1528.889.1528z"></path><path d="m211.309 39.7906v6.1648h-1.222v-6.1648h-2.263v-1.0414h5.79v1.0414z"></path></g><path d="m49.45.844971v20.155029h3.509v-8.758h6.554v8.758h3.509v-20.155029h-3.509v8.670999h-6.554v-8.670999z" fill="currentColor"></path><path d="m76.8364 11.053c0-3.53803-1.798-4.87203-5.452-4.87203-2.291 0-4.089.725-5.133 1.334v2.87103c.928-.69603 2.958-1.45003 4.727-1.45003 1.653 0 2.407.58 2.407 2.14603v.812h-.551c-5.278 0-7.627 1.74-7.627 4.698s1.798 4.611 4.466 4.611c2.03 0 2.9-.667 3.567-1.363h.145c.029.377.145.87.261 1.16h3.364c-.116-1.189-.174-2.378-.174-3.567zm-3.451 6.467c-.435.638-1.247 1.16-2.465 1.16-1.45 0-2.175-.87-2.175-2.175 0-1.711 1.189-2.32 4.147-2.32h.493z" fill="currentColor"></path><path d="m82.8011 6.41297h-3.19v18.79203h3.451v-5.916c.87 1.305 2.146 2.001 3.625 2.001 3.364 0 5.684-2.697 5.684-7.598 0-4.87203-2.262-7.56903-5.51-7.56903-1.624 0-2.958.754-3.886 2.175zm3.016 12.15103c-1.827 0-2.755-1.479-2.755-4.843 0-3.393.986-4.87203 2.929-4.87203 1.885 0 2.813 1.47903 2.813 4.84303 0 3.393-.986 4.872-2.987 4.872z" fill="currentColor"></path><path d="m100.535 6.12297c-3.7985 0-6.4375 2.697-6.4375 7.59803 0 4.872 2.639 7.569 6.4375 7.569 3.799 0 6.438-2.697 6.438-7.598 0-4.87203-2.639-7.56903-6.438-7.56903zm0 12.44103c-1.9135 0-2.8705-1.479-2.8705-4.843 0-3.393.957-4.87203 2.8705-4.87203 1.914 0 2.871 1.47903 2.871 4.84303 0 3.393-.957 4.872-2.871 4.872z" fill="currentColor"></path><path d="m121.627 18.274h-1.537v-11.86103h-10.063v1.247c0 3.56703-.232 8.17803-1.45 10.61403h-1.073v6.061h3.19v-3.335h7.743v3.335h3.19zm-4.988 0h-4.872c.957-2.204 1.218-6.177 1.218-8.70003v-.435h3.654z" fill="currentColor"></path><path d="m131.513 6.41297v5.77103h-4.611v-5.77103h-3.451v14.58703h3.451v-6.09h4.611v6.09h3.451v-14.58703z" fill="currentColor"></path><path d="m148.77 11.053c0-3.53803-1.798-4.87203-5.452-4.87203-2.291 0-4.089.725-5.133 1.334v2.87103c.928-.69603 2.958-1.45003 4.727-1.45003 1.653 0 2.407.58 2.407 2.14603v.812h-.551c-5.278 0-7.627 1.74-7.627 4.698s1.798 4.611 4.466 4.611c2.03 0 2.9-.667 3.567-1.363h.145c.029.377.145.87.261 1.16h3.364c-.116-1.189-.174-2.378-.174-3.567zm-3.451 6.467c-.435.638-1.247 1.16-2.465 1.16-1.45 0-2.175-.87-2.175-2.175 0-1.711 1.189-2.32 4.147-2.32h.493z" fill="currentColor"></path><path d="m150.53 21h3.538l2.784-4.756h1.653v4.756h3.451v-14.58703h-5.278c-3.364 0-5.771 1.711-5.771 4.84303 0 2.204 1.044 3.596 2.9 4.234zm6.409-11.86103h1.566v4.58203h-1.653c-1.566 0-2.436-.667-2.436-2.349 0-1.59503 1.015-2.23303 2.523-2.23303z" fill="currentColor"></path><path d="m179.216 21h3.915l-5.539-7.859 4.872-6.72803h-3.48l-4.872 6.72803v-6.72803h-3.451v14.58703h3.451v-7.163z" fill="currentColor"></path><path d="m194.875 11.053c0-3.53803-1.798-4.87203-5.452-4.87203-2.291 0-4.089.725-5.133 1.334v2.87103c.928-.69603 2.958-1.45003 4.727-1.45003 1.653 0 2.407.58 2.407 2.14603v.812h-.551c-5.278 0-7.627 1.74-7.627 4.698s1.798 4.611 4.466 4.611c2.03 0 2.9-.667 3.567-1.363h.145c.029.377.145.87.261 1.16h3.364c-.116-1.189-.174-2.378-.174-3.567zm-3.451 6.467c-.435.638-1.247 1.16-2.465 1.16-1.45 0-2.175-.87-2.175-2.175 0-1.711 1.189-2.32 4.147-2.32h.493z" fill="currentColor"></path><path d="m200.84 6.41297h-3.19v18.79203h3.451v-5.916c.87 1.305 2.146 2.001 3.625 2.001 3.364 0 5.684-2.697 5.684-7.598 0-4.87203-2.262-7.56903-5.51-7.56903-1.624 0-2.958.754-3.886 2.175zm3.016 12.15103c-1.827 0-2.755-1.479-2.755-4.843 0-3.393.986-4.87203 2.929-4.87203 1.885 0 2.813 1.47903 2.813 4.84303 0 3.393-.986 4.872-2.987 4.872z" fill="currentColor"></path><path d="m222.54 9.13897v-2.726h-11.571v2.726h4.06v11.86103h3.451v-11.86103z" fill="currentColor"></path><path d="m234.609 11.053c0-3.53803-1.798-4.87203-5.452-4.87203-2.291 0-4.089.725-5.133 1.334v2.87103c.928-.69603 2.958-1.45003 4.727-1.45003 1.653 0 2.407.58 2.407 2.14603v.812h-.551c-5.278 0-7.627 1.74-7.627 4.698s1.798 4.611 4.466 4.611c2.03 0 2.9-.667 3.567-1.363h.145c.029.377.145.87.261 1.16h3.364c-.116-1.189-.174-2.378-.174-3.567zm-3.451 6.467c-.435.638-1.247 1.16-2.465 1.16-1.45 0-2.175-.87-2.175-2.175 0-1.711 1.189-2.32 4.147-2.32h.493z" fill="currentColor"></path></svg>
        </a>
        
        {% if not token_configured %}
        <div class="warning-section">
            <h2>ВНИМАНИЕ</h2>
            <p>Получите OAuth-токен, вставьте его в config.py и перезапустите приложение</p>
        </div>
        {% endif %}
        
        <div class="upload-section">
            <input type="file" id="fileInput" multiple accept=".zip" style="display: none;">
            <button id="uploadBtn" class="upload-button" {% if not token_configured %}disabled{% endif %}>Загрузить ShapeFile</button>
            <input type="file" id="geojsonInput" multiple accept=".geojson,.json" style="display: none;">
            <button id="geojsonUploadBtn" class="upload-button" {% if not token_configured %}disabled{% endif %}>Загрузить GeoJSON</button>
        </div>
        
        <div id="results" class="results-section" style="display: none;">
            <div id="processedFiles" class="files-list"></div>
            <div id="failedFiles" class="files-list"></div>
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            <div class="progress-container">
                <div class="progress-header">
                    <span id="currentStage" class="current-stage">Инициализация...</span>
                </div>
                <div class="progress-bar-wrapper">
                    <div class="progress-bar" id="mainProgressBar">
                        <div class="progress-bar-fill" id="mainProgressFill"></div>
                    </div>
                    <div class="progress-info">
                        <span id="progressPercentage">0%</span>
                        <span id="progressCounter">0/0</span>
                    </div>
                </div>
                <div id="fileProgressList" class="file-progress-list"></div>
            </div>
        </div>
    </div>
    
    <script>
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const geojsonUploadBtn = document.getElementById('geojsonUploadBtn');
        const geojsonInput = document.getElementById('geojsonInput');
        const results = document.getElementById('results');
        const loading = document.getElementById('loading');
        const processedFiles = document.getElementById('processedFiles');
        const failedFiles = document.getElementById('failedFiles');
        
        uploadBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        geojsonUploadBtn.addEventListener('click', () => {
            geojsonInput.click();
        });
        
        function setupFileUpload(inputElement, uploadEndpoint, buttonElement) {
            inputElement.addEventListener('change', async (e) => {
                const files = e.target.files;
                if (files.length === 0) return;
                
                const formData = new FormData();
                for (let file of files) {
                    formData.append('files', file);
                }
                
                // Показываем загрузку
                loading.style.display = 'block';
                results.style.display = 'none';
                uploadBtn.disabled = true;
                geojsonUploadBtn.disabled = true;
                
                // Сбрасываем прогресс
                document.getElementById('currentStage').textContent = 'Загрузка файлов...';
                document.getElementById('progressPercentage').textContent = '0%';
                document.getElementById('progressCounter').textContent = '0/0';
                document.getElementById('mainProgressFill').style.width = '0%';
                document.getElementById('fileProgressList').innerHTML = '';
                
                let eventSource = null;
                
                try {
                    const response = await fetch(uploadEndpoint, {
                        method: 'POST',
                        body: formData
                    });
                    
                    // Проверяем статус ответа
                    if (!response.ok) {
                        let errorText = `Ошибка сервера (${response.status}): `;
                        try {
                            const errorData = await response.json();
                            errorText += errorData.error || response.statusText;
                        } catch (e) {
                            errorText += response.statusText;
                        }
                        alert(errorText);
                        loading.style.display = 'none';
                        uploadBtn.disabled = false;
                        geojsonUploadBtn.disabled = false;
                        return;
                    }
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        alert('Ошибка: ' + data.error);
                        loading.style.display = 'none';
                        uploadBtn.disabled = false;
                        geojsonUploadBtn.disabled = false;
                        return;
                    }
                    
                    // Подключаемся к SSE потоку
                    const sessionId = data.session_id;
                    eventSource = new EventSource(`/progress/${sessionId}`);
                    
                    eventSource.addEventListener('progress', (e) => {
                        const progressData = JSON.parse(e.data);
                        
                        // Обновляем общий прогресс
                        if (progressData.current_stage) {
                            document.getElementById('currentStage').textContent = progressData.current_stage;
                        }
                        
                        if (progressData.percentage !== undefined) {
                            document.getElementById('progressPercentage').textContent = `${progressData.percentage}%`;
                            document.getElementById('mainProgressFill').style.width = `${progressData.percentage}%`;
                        }
                        
                        if (progressData.current !== undefined && progressData.total !== undefined) {
                            document.getElementById('progressCounter').textContent = `${progressData.current}/${progressData.total}`;
                        }
                        
                        // Обновляем прогресс по файлам
                        if (progressData.file_progress) {
                            const fileProgressList = document.getElementById('fileProgressList');
                            fileProgressList.innerHTML = '';
                            
                            Object.entries(progressData.file_progress).forEach(([filename, fileData]) => {
                                const fileDiv = document.createElement('div');
                                fileDiv.className = 'file-progress-item';
                                
                                const statusClass = fileData.status === 'completed' ? 'completed' : 
                                                  fileData.status === 'failed' ? 'failed' : 'processing';
                                
                                fileDiv.innerHTML = `
                                    <div class="file-progress-name ${statusClass}">${filename}</div>
                                    <div class="file-progress-bar">
                                        <div class="file-progress-fill ${statusClass}" style="width: ${fileData.progress || 0}%"></div>
                                    </div>
                                    ${fileData.error ? `<div class="file-progress-error">${fileData.error}</div>` : ''}
                                `;
                                fileProgressList.appendChild(fileDiv);
                            });
                        }
                        
                        // Если обработка завершена
                        if (progressData.status === 'completed') {
                            eventSource.close();
                            
                            // Отображаем результаты
                            if (progressData.processed && progressData.processed.length > 0) {
                                processedFiles.innerHTML = '<h3>Загружено:</h3><ul>' +
                                    progressData.processed.map(f => {
                                        const parts = [];
                                        if (f.category_t) parts.push(f.category_t);
                                        if (f.title) parts.push(f.title);
                                        const infoPart = parts.length > 0 ? ` - ${parts.join(' ')}` : '';
                                        return `<li>${f.name}${infoPart} (${f.size})</li>`;
                                    }).join('') +
                                    '</ul>';
                            } else {
                                processedFiles.innerHTML = '';
                            }
                            
                            if (progressData.failed && progressData.failed.length > 0) {
                                failedFiles.innerHTML = '<h3>Пропущено:</h3><ul>' +
                                    progressData.failed.map(f => `<li>${f.name} (${f.size}): ${f.error || 'Неизвестная ошибка'}</li>`).join('') +
                                    '</ul>';
                            } else {
                                failedFiles.innerHTML = '';
                            }
                            
                            results.style.display = 'block';
                            loading.style.display = 'none';
                            uploadBtn.disabled = false;
                            geojsonUploadBtn.disabled = false;
                            fileInput.value = '';
                            geojsonInput.value = '';
                        }
                        
                        // Если произошла ошибка
                        if (progressData.status === 'error') {
                            eventSource.close();
                            alert('Ошибка обработки: ' + (progressData.error || 'Неизвестная ошибка'));
                            loading.style.display = 'none';
                            uploadBtn.disabled = false;
                            geojsonUploadBtn.disabled = false;
                            fileInput.value = '';
                            geojsonInput.value = '';
                        }
                    });
                    
                    eventSource.onerror = (error) => {
                        console.error('Ошибка SSE:', error);
                        if (eventSource) {
                            eventSource.close();
                        }
                        alert('Ошибка подключения к потоку прогресса');
                        loading.style.display = 'none';
                        uploadBtn.disabled = false;
                        geojsonUploadBtn.disabled = false;
                    };
                    
                } catch (error) {
                    console.error('Ошибка загрузки:', error);
                    if (eventSource) {
                        eventSource.close();
                    }
                    alert('Ошибка загрузки: ' + (error.message || 'Неизвестная ошибка'));
                    loading.style.display = 'none';
                    uploadBtn.disabled = false;
                    geojsonUploadBtn.disabled = false;
                    fileInput.value = '';
                    geojsonInput.value = '';
                }
            });
        }
        
        // Настраиваем загрузку для SHP файлов
        setupFileUpload(fileInput, '/upload', uploadBtn);
        
        // Настраиваем загрузку для GeoJSON файлов
        setupFileUpload(geojsonInput, '/upload-geojson', geojsonUploadBtn);
    </script>
</body>
</html>

